<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="sqlmap_hy_order" >
  <resultMap id="BaseResultMap" type="net.chetong.order.model.HyOrderVO" >
    <id column="id" property="id" jdbcType="BIGINT" />
    <result column="order_no" property="orderNo" jdbcType="VARCHAR" />
    <result column="deal_stat" property="dealStat" jdbcType="VARCHAR" />
    <result column="seller_user_id" property="sellerUserId" jdbcType="BIGINT" />
    <result column="buyer_user_id" property="buyerUserId" jdbcType="BIGINT" />
    <result column="entrust_user_id" property="entrustUserId" jdbcType="BIGINT" />
    <result column="payer_user_id" property="payerUserId" jdbcType="BIGINT" />
    <result column="payer_user_name" property="payerUserName" jdbcType="BIGINT" />
    <result column="seller_user_name" property="sellerUserName" jdbcType="VARCHAR" />
    <result column="buyer_user_name" property="buyerUserName" jdbcType="VARCHAR" />
    <result column="entrust_user_name" property="entrustUserName" jdbcType="VARCHAR" />
    <result column="case_no" property="caseNo" jdbcType="VARCHAR" />
    <result column="service_id" property="serviceId" jdbcType="BIGINT" />
    <result column="subject_id" property="subjectId" jdbcType="BIGINT" />
    <result column="send_address" property="sendAddress" jdbcType="VARCHAR" />
    <result column="longtitude" property="longtitude" jdbcType="REAL" />
    <result column="latitude" property="latitude" jdbcType="REAL" />
    <result column="get_time" property="getTime" jdbcType="TIMESTAMP" />
    <result column="finish_time" property="finishTime" jdbcType="TIMESTAMP" />
    <result column="final_time" property="finalTime" jdbcType="TIMESTAMP" />
    <result column="send_time" property="sendTime" jdbcType="TIMESTAMP" />
    <result column="prov_code" property="provCode" jdbcType="VARCHAR" />
    <result column="city_code" property="cityCode" jdbcType="VARCHAR" />
    <result column="area_code" property="areaCode" jdbcType="VARCHAR" />
    <result column="grab_address" property="grabAddress" jdbcType="VARCHAR" />
    <result column="grab_longtitude" property="grabLongtitude" jdbcType="REAL" />
    <result column="grab_latitude" property="grabLatitude" jdbcType="REAL" />
    <result column="group_user_id" property="groupUserId" jdbcType="BIGINT" />
    <result column="group_user_name" property="groupUserName" jdbcType="VARCHAR" />
    <result column="buyer_tel" property="buyerTel" jdbcType="VARCHAR" />
    <result column="seller_tel" property="sellerTel" jdbcType="VARCHAR" />
    <result column="entrust_tel" property="entrustTel" jdbcType="VARCHAR" />
    <result column="send_user_id" property="sendUserId" jdbcType="BIGINT" />
    <result column="send_user_name" property="sendUserName" jdbcType="VARCHAR" />
    <result column="preliminary_time" property="preliminaryTime" jdbcType="TIMESTAMP" />
    <result column="is_entrust" property="isEntrust" jdbcType="INTEGER" />
    <result column="is_confirm" property="isConfirm" jdbcType="VARCHAR" />
    <result column="created_by" property="createdBy" jdbcType="VARCHAR" />
    <result column="updated_by" property="updatedBy" jdbcType="VARCHAR" />
    <result column="create_time" property="createTime" jdbcType="TIMESTAMP" />
    <result column="update_time" property="updateTime" jdbcType="TIMESTAMP" />
    <result column="task_id" property="taskId" jdbcType="BIGINT" />
    <result column="work_id" property="workId" jdbcType="BIGINT" />
    <result column="mileage" property="mileage" jdbcType="REAL" />
  </resultMap>
      <!-- 保存货运险订单留言信息 -->
	<insert id="saveHyLeave" parameterType="java.util.Map" useGeneratedKeys="true" keyProperty="id">
			INSERT INTO fh_leave_model   
			(
				<trim suffix="" suffixOverrides=",">
		                   name,
		             insert_time,
					<if test="detail!= null">
		                   detail,
		            </if>
					<if test="orderNo!= null">
		                   reserved,
		            </if>
		            <if test="userId!= null">
		                   user_id,
		            </if>
		            <if test="leaveRole!= null">
		                   leave_role,
		            </if>
		            <if test="leaveType!= null">
		                   leave_type,
		            </if>
		            <if test="creatTime!= null">
		                   creat_time,
		            </if>
		            <if test="displayTime!= null">
		                   display_time,
		            </if>
	            </trim>
			)
			VALUES
	   		(
	   			<trim suffix="" suffixOverrides=",">
		   			#{name},
		   			NOW(),
		   			<if test="detail!= null">
		   			#{detail},
		   			</if>
		   			<if test="orderNo!= null">
		   			#{orderNo},
		   			</if>
		   			<if test="userId!= null">
		   			#{userId},
		   			</if>
		   			<if test="leaveRole!= null">
		   			#{leaveRole},
		   			</if>
		   			<if test="leaveType!= null">
		   			#{leaveType},
		   			</if>
		   			<if test="creatTime!= null">
		   			#{creatTime},
		   			</if>
		   			<if test="displayTime!= null">
		   			#{displayTime},
		   			</if>
	   			</trim>
			)
		</insert>
		
	<!-- 根据货运险订单号查询留言 -->
    <select id="queryHyLeaveByOrderNo" parameterType="java.lang.String" resultType="Map">
        SELECT 
        	f.user_id as userId,
        	f.leave_role as leaveRole,
        	f.leave_type as leaveType,
        	f.creat_time as creatTime,
        	f.display_time as displayTime,
			f.insert_time as insertTime,
			f.detail as detail,
  			(SELECT a.att_url FROM ct_attachment a WHERE a.user_id=f.user_id AND a.att_code='icon') AS headImage
		 FROM fh_leave_model f
		 WHERE reserved=#{orderNo}
    </select>
    
    <!-- 更新留言状态 -->
    <update id="updateHyLeaveStat" parameterType="map">
    	update 
    	fh_leave_model SET has_readed = '1' 
    	<where>
    		reserved = #{orderNo}
    	</where>
    </update>
    
    <!-- 查询是否有新留言 -->
    <select id="queryNewLeaveCount" parameterType="map" resultType="int">
    	select count(1) from fh_leave_model 
    	<where>
    	reserved = #{orderNo}
    	AND user_id != #{userId}
    	AND has_readed = '0'
    	</where>
    </select>
    
    <!-- 全局搜索 -->
    <select id="indexKeySearch" parameterType="java.util.Map" resultType="java.util.Map">
    (		
		SELECT
			fm.service_id AS serviceId,
			fm.deal_stat AS dealStat,
			fm.order_no AS orderNo,
			fm.order_type AS orderType,
			fm.case_id AS caseId,
			fm.case_no AS caseNo,
			fm.buyer_user_id AS buyerUserId,
			fm.buyer_user_name AS buyerUserName,
			(
				SELECT
					g.conn_tel1
				FROM
					ct_group g
				WHERE
					g.user_id = fm.buyer_user_id
			) AS buyerMobile,
			fm.work_address AS workAddress,
			fm.car_no AS carNo,
			fm.is_simple AS isSimple,
			oc.accident_Time AS accidentTime,
			'' AS supportLinkman,
			'' AS supportLinktel,
			'' AS entrustUserName,
			'' AS transportType,
			fm.send_time AS sendTime
		FROM
			fm_order fm INNER JOIN fm_order_case_cx oc ON fm.case_no = oc.case_no
		<where>
			<if test="userId != null">
			fm.seller_user_id = #{userId}
			</if>
				<if test="keyWords != null">
				AND (
					fm.order_no LIKE concat('%', #{keyWords}, '%')
					OR fm.case_no LIKE concat('%', #{keyWords}, '%')
					OR fm.car_no LIKE concat('%', #{keyWords}, '%')
					OR fm.work_address LIKE concat('%', #{keyWords}, '%')
				)
				</if>
				
		</where>
	)
	
		UNION
	
	(
		SELECT
			hy.service_id AS serviceId,
			hy.deal_stat AS dealStat,
			hy.order_no AS orderNo,
			hy.subject_id AS orderType,
			(
				SELECT
					h.id
				FROM
					hy_order_case h
				WHERE
					hy.case_no = h.case_no
			) AS caseId,
			hy.case_no AS caseNo,
			hy.buyer_user_id AS buyerUserId,
			hy.buyer_user_name AS buyerUserName,
			(
				SELECT
					g.conn_tel1
				FROM
					ct_group g
				WHERE
					g.user_id = hy.buyer_user_id
			) AS buyerMobile,
			hy.send_address AS workAddress,
			'' AS carNo,
			'' AS isSimple,
			t.accident_time AS accidentTime,
			t.support_linkman AS supportLinkman,
			t.support_linktel AS supportLinktel,
			hy.entrust_user_name AS entrustUserName,
			t.transport_type AS transportType,
			hy.send_time AS sendTime
		FROM
			hy_order hy INNER JOIN hy_order_task t ON hy.order_no = t.order_no
		<where>
			<if test="userId != null">
				hy.seller_user_id = #{userId}
			</if>
				<if test="keyWords != null">
				AND (
					hy.order_no LIKE concat('%', #{keyWords}, '%')
					OR hy.case_no LIKE concat('%', #{keyWords}, '%')
					OR hy.send_address LIKE concat('%', #{keyWords}, '%')
				)
				</if>
				
		</where>
	)
			
		UNION
	
	(
		SELECT
			o.service_id AS serviceId,
			o.deal_stat AS dealStat,
			o.order_no AS orderNo,
			o.subject_id AS orderType,
			c.id AS caseId,
			o.case_no AS caseNo,
			o.buyer_user_id AS buyerUserId,
			o.buyer_user_name AS buyeruserName,
			(
				SELECT
					g.conn_tel1
				FROM
					ct_group g
				WHERE
					g.user_id = o.buyer_user_id
			) AS buyerMobile,
			o.work_address AS workAddress,
			t.car_no AS carNo,
			'' AS isSimple,
			c.accident_time AS accidentTime,
			'' AS supportLinkman,
			'' AS supportLinktel,
			t.entrust_name AS entrustUserName,
			'' AS transportType,
			o.send_time AS sendTime
		FROM
			rs_order o,
			fm_order_case_cx c,
			rs_task_info_detail t
		<where>
			<if test="userId != null">
				o.seller_user_id = #{userId}
			</if>
			<if test="keyWords != null">
				AND (
					o.order_no LIKE concat('%', #{keyWords}, '%')
					OR o.case_no LIKE concat('%', #{keyWords}, '%')
					OR t.car_no LIKE concat('%', #{keyWords}, '%')
					OR o.work_address LIKE concat('%', #{keyWords}, '%')
				)
			</if>
				
			AND o.case_no = c.case_no
			AND o.task_detail_id = t.id
			AND o.is_resend = '0'
		</where>
	)  order by sendTime desc
	</select>
	
	<!-- 查勘完成确认 -->
	<update id="confirmFinish" parameterType="java.util.Map">
		UPDATE hy_order
		<set>
			<if test="updatedBy != null" >
        		updated_by = #{updatedBy,jdbcType=VARCHAR},
      		</if>
      		<if test="dealStat != null" >
        		deal_stat = #{dealStat,jdbcType=VARCHAR},
      		</if>
      		<if test="isConfirm != null and isConfirm != ''" >
        		is_confirm = #{isConfirm,jdbcType=VARCHAR},
      		</if>
      		finish_time = NOW(),
        	update_time = NOW()
		</set>
		<where>
			<if test="id != null">
				id = #{id}
			</if>
			<if test="orderNo != null">
				AND order_no = #{orderNo}
			</if>
		</where>
	</update>
	
  <sql id="Base_Column_List" >
    id, order_no,task_id,work_id,mileage,deal_stat, seller_user_id, buyer_user_id, entrust_user_id, payer_user_id, 
    payer_user_name, seller_user_name, buyer_user_name, entrust_user_name, case_no, service_id, 
    subject_id, send_address, longtitude, latitude, get_time, finish_time, final_time, 
    send_time, prov_code, city_code, area_code, grab_address, grab_longtitude, grab_latitude, 
    group_user_id, group_user_name, buyer_tel, seller_tel, entrust_tel, send_user_id, 
    send_user_name, preliminary_time, is_entrust, is_confirm, created_by, updated_by, create_time, 
    update_time
  </sql>
  <select id="selectByPrimaryKey" resultMap="BaseResultMap" parameterType="java.lang.Long" >
    select 
    <include refid="Base_Column_List" />
    from hy_order
    where id = #{id,jdbcType=BIGINT}
  </select>
  <delete id="deleteByPrimaryKey" parameterType="java.lang.Long" >
    delete from hy_order
    where id = #{id,jdbcType=BIGINT}
  </delete>
  <insert id="insert" parameterType="net.chetong.order.model.HyOrderVO" >
    insert into hy_order (id,task_id,work_id,mileage,order_no, deal_stat, 
      seller_user_id, buyer_user_id, entrust_user_id, 
      payer_user_id, payer_user_name, seller_user_name, 
      buyer_user_name, entrust_user_name, case_no, 
      service_id, subject_id, send_address, 
      longtitude, latitude, get_time, 
      finish_time, final_time, send_time, 
      prov_code, city_code, area_code, 
      grab_address, grab_longtitude, grab_latitude, 
      group_user_id, group_user_name, buyer_tel, 
      seller_tel, entrust_tel, send_user_id, 
      send_user_name, preliminary_time, is_entrust, is_confirm, 
      created_by, updated_by, create_time, 
      update_time)
    values (#{id,jdbcType=BIGINT},#{taskId,jdbcType=BIGINT},#{workId,jdbcType=BIGINT},#{mileage,jdbcType=REAL},
      #{orderNo,jdbcType=VARCHAR}, #{dealStat,jdbcType=VARCHAR}, 
      #{sellerUserId,jdbcType=BIGINT}, #{buyerUserId,jdbcType=BIGINT}, #{entrustUserId,jdbcType=BIGINT}, 
      #{payerUserId,jdbcType=BIGINT}, #{payerUserName,jdbcType=BIGINT}, #{sellerUserName,jdbcType=VARCHAR}, 
      #{buyerUserName,jdbcType=VARCHAR}, #{entrustUserName,jdbcType=VARCHAR}, #{caseNo,jdbcType=VARCHAR}, 
      #{serviceId,jdbcType=BIGINT}, #{subjectId,jdbcType=BIGINT}, #{sendAddress,jdbcType=VARCHAR}, 
      #{longtitude,jdbcType=REAL}, #{latitude,jdbcType=REAL}, #{getTime,jdbcType=TIMESTAMP}, 
      #{finishTime,jdbcType=TIMESTAMP}, #{finalTime,jdbcType=TIMESTAMP}, #{sendTime,jdbcType=TIMESTAMP}, 
      #{provCode,jdbcType=VARCHAR}, #{cityCode,jdbcType=VARCHAR}, #{areaCode,jdbcType=VARCHAR}, 
      #{grabAddress,jdbcType=VARCHAR}, #{grabLongtitude,jdbcType=REAL}, #{grabLatitude,jdbcType=REAL}, 
      #{groupUserId,jdbcType=BIGINT}, #{groupUserName,jdbcType=VARCHAR}, #{buyerTel,jdbcType=VARCHAR}, 
      #{sellerTel,jdbcType=VARCHAR}, #{entrustTel,jdbcType=VARCHAR}, #{sendUserId,jdbcType=BIGINT}, 
      #{sendUserName,jdbcType=VARCHAR}, #{preliminaryTime,jdbcType=TIMESTAMP}, #{isEntrust}, #{isConfirm,jdbcType=VARCHAR}, 
      #{createdBy,jdbcType=VARCHAR}, #{updatedBy,jdbcType=VARCHAR}, #{createTime,jdbcType=TIMESTAMP}, 
      #{updateTime,jdbcType=TIMESTAMP})
  </insert>
  <insert id="insertSelective" parameterType="net.chetong.order.model.HyOrderVO"  useGeneratedKeys="true" keyProperty="id">
    insert into hy_order
    <trim prefix="(" suffix=")" suffixOverrides="," >
      <if test="id != null" >
        id,
      </if>
      <if test="taskId != null" >
        task_id,
      </if>
      <if test="workId != null" >
        work_id,
      </if>
      <if test="mileage != null" >
        mileage,
      </if>
      <if test="orderNo != null" >
        order_no,
      </if>
      <if test="dealStat != null" >
        deal_stat,
      </if>
      <if test="sellerUserId != null" >
        seller_user_id,
      </if>
      <if test="buyerUserId != null" >
        buyer_user_id,
      </if>
      <if test="entrustUserId != null" >
        entrust_user_id,
      </if>
      <if test="payerUserId != null" >
        payer_user_id,
      </if>
      <if test="payerUserName != null" >
        payer_user_name,
      </if>
      <if test="sellerUserName != null" >
        seller_user_name,
      </if>
      <if test="buyerUserName != null" >
        buyer_user_name,
      </if>
      <if test="entrustUserName != null" >
        entrust_user_name,
      </if>
      <if test="caseNo != null" >
        case_no,
      </if>
      <if test="serviceId != null" >
        service_id,
      </if>
      <if test="subjectId != null" >
        subject_id,
      </if>
      <if test="sendAddress != null" >
        send_address,
      </if>
      <if test="longtitude != null" >
        longtitude,
      </if>
      <if test="latitude != null" >
        latitude,
      </if>
      <if test="getTime != null" >
        get_time,
      </if>
      <if test="finishTime != null" >
        finish_time,
      </if>
      <if test="finalTime != null" >
        final_time,
      </if>
      <if test="sendTime != null" >
        send_time,
      </if>
      <if test="provCode != null" >
        prov_code,
      </if>
      <if test="cityCode != null" >
        city_code,
      </if>
      <if test="areaCode != null" >
        area_code,
      </if>
      <if test="grabAddress != null" >
        grab_address,
      </if>
      <if test="grabLongtitude != null" >
        grab_longtitude,
      </if>
      <if test="grabLatitude != null" >
        grab_latitude,
      </if>
      <if test="groupUserId != null" >
        group_user_id,
      </if>
      <if test="groupUserName != null" >
        group_user_name,
      </if>
      <if test="buyerTel != null" >
        buyer_tel,
      </if>
      <if test="sellerTel != null" >
        seller_tel,
      </if>
      <if test="entrustTel != null" >
        entrust_tel,
      </if>
      <if test="sendUserId != null" >
        send_user_id,
      </if>
      <if test="sendUserName != null" >
        send_user_name,
      </if>
      <if test="preliminaryTime != null" >
        preliminary_time,
      </if>
      <if test="isEntrust != null" >
        is_entrust,
      </if>
      <if test="isConfirm != null" >
        is_confirm,
      </if>
      <if test="createdBy != null" >
        created_by,
      </if>
      <if test="updatedBy != null" >
        updated_by,
      </if>
      <if test="createTime != null" >
        create_time,
      </if>
      <if test="updateTime != null" >
        update_time,
      </if>
    </trim>
    <trim prefix="values (" suffix=")" suffixOverrides="," >
      <if test="id != null" >
        #{id,jdbcType=BIGINT},
      </if>
      <if test="taskId != null" >
        #{taskId,jdbcType=BIGINT},
      </if>
      <if test="workId != null" >
        #{workId,jdbcType=BIGINT},
      </if>
      <if test="mileage != null" >
        #{mileage,jdbcType=REAL},
      </if>
      <if test="orderNo != null" >
        #{orderNo,jdbcType=VARCHAR},
      </if>
      <if test="dealStat != null" >
        #{dealStat,jdbcType=VARCHAR},
      </if>
      <if test="sellerUserId != null" >
        #{sellerUserId,jdbcType=BIGINT},
      </if>
      <if test="buyerUserId != null" >
        #{buyerUserId,jdbcType=BIGINT},
      </if>
      <if test="entrustUserId != null" >
        #{entrustUserId,jdbcType=BIGINT},
      </if>
      <if test="payerUserId != null" >
        #{payerUserId,jdbcType=BIGINT},
      </if>
      <if test="payerUserName != null" >
        #{payerUserName,jdbcType=BIGINT},
      </if>
      <if test="sellerUserName != null" >
        #{sellerUserName,jdbcType=VARCHAR},
      </if>
      <if test="buyerUserName != null" >
        #{buyerUserName,jdbcType=VARCHAR},
      </if>
      <if test="entrustUserName != null" >
        #{entrustUserName,jdbcType=VARCHAR},
      </if>
      <if test="caseNo != null" >
        #{caseNo,jdbcType=VARCHAR},
      </if>
      <if test="serviceId != null" >
        #{serviceId,jdbcType=BIGINT},
      </if>
      <if test="subjectId != null" >
        #{subjectId,jdbcType=BIGINT},
      </if>
      <if test="sendAddress != null" >
        #{sendAddress,jdbcType=VARCHAR},
      </if>
      <if test="longtitude != null" >
        #{longtitude,jdbcType=REAL},
      </if>
      <if test="latitude != null" >
        #{latitude,jdbcType=REAL},
      </if>
      <if test="getTime != null" >
        #{getTime,jdbcType=TIMESTAMP},
      </if>
      <if test="finishTime != null" >
        #{finishTime,jdbcType=TIMESTAMP},
      </if>
      <if test="finalTime != null" >
        #{finalTime,jdbcType=TIMESTAMP},
      </if>
      <if test="sendTime != null" >
        #{sendTime,jdbcType=TIMESTAMP},
      </if>
      <if test="provCode != null" >
        #{provCode,jdbcType=VARCHAR},
      </if>
      <if test="cityCode != null" >
        #{cityCode,jdbcType=VARCHAR},
      </if>
      <if test="areaCode != null" >
        #{areaCode,jdbcType=VARCHAR},
      </if>
      <if test="grabAddress != null" >
        #{grabAddress,jdbcType=VARCHAR},
      </if>
      <if test="grabLongtitude != null" >
        #{grabLongtitude,jdbcType=REAL},
      </if>
      <if test="grabLatitude != null" >
        #{grabLatitude,jdbcType=REAL},
      </if>
      <if test="groupUserId != null" >
        #{groupUserId,jdbcType=BIGINT},
      </if>
      <if test="groupUserName != null" >
        #{groupUserName,jdbcType=VARCHAR},
      </if>
      <if test="buyerTel != null" >
        #{buyerTel,jdbcType=VARCHAR},
      </if>
      <if test="sellerTel != null" >
        #{sellerTel,jdbcType=VARCHAR},
      </if>
      <if test="entrustTel != null" >
        #{entrustTel,jdbcType=VARCHAR},
      </if>
      <if test="sendUserId != null" >
        #{sendUserId,jdbcType=BIGINT},
      </if>
      <if test="sendUserName != null" >
        #{sendUserName,jdbcType=VARCHAR},
      </if>
      <if test="preliminaryTime != null" >
        #{preliminaryTime,jdbcType=TIMESTAMP},
      </if>
      <if test="isEntrust != null" >
        #{isEntrust},
      </if>
      <if test="isConfirm != null" >
        #{isConfirm,jdbcType=VARCHAR},
      </if>
      <if test="createdBy != null" >
        #{createdBy,jdbcType=VARCHAR},
      </if>
      <if test="updatedBy != null" >
        #{updatedBy,jdbcType=VARCHAR},
      </if>
      <if test="createTime != null" >
        #{createTime,jdbcType=TIMESTAMP},
      </if>
      <if test="updateTime != null" >
        #{updateTime,jdbcType=TIMESTAMP},
      </if>
    </trim>
  </insert>
  <update id="updateByPrimaryKeySelective" parameterType="net.chetong.order.model.HyOrderVO" >
    update hy_order
    <set >
      <if test="orderNo != null" >
        order_no = #{orderNo,jdbcType=VARCHAR},
      </if>
      <if test="taskId != null" >
        task_id = #{taskId,jdbcType=BIGINT},
      </if>
      <if test="workId != null" >
        work_id = #{workId,jdbcType=BIGINT},
      </if>
      <if test="mileage != null" >
        mileage = #{mileage,jdbcType=REAL},
      </if>
      <if test="dealStat != null" >
        deal_stat = #{dealStat,jdbcType=VARCHAR},
      </if>
      <if test="sellerUserId != null" >
        seller_user_id = #{sellerUserId,jdbcType=BIGINT},
      </if>
      <if test="buyerUserId != null" >
        buyer_user_id = #{buyerUserId,jdbcType=BIGINT},
      </if>
      <if test="entrustUserId != null" >
        entrust_user_id = #{entrustUserId,jdbcType=BIGINT},
      </if>
      <if test="payerUserId != null" >
        payer_user_id = #{payerUserId,jdbcType=BIGINT},
      </if>
      <if test="payerUserName != null" >
        payer_user_name = #{payerUserName,jdbcType=BIGINT},
      </if>
      <if test="sellerUserName != null" >
        seller_user_name = #{sellerUserName,jdbcType=VARCHAR},
      </if>
      <if test="buyerUserName != null" >
        buyer_user_name = #{buyerUserName,jdbcType=VARCHAR},
      </if>
      <if test="entrustUserName != null" >
        entrust_user_name = #{entrustUserName,jdbcType=VARCHAR},
      </if>
      <if test="caseNo != null" >
        case_no = #{caseNo,jdbcType=VARCHAR},
      </if>
      <if test="serviceId != null" >
        service_id = #{serviceId,jdbcType=BIGINT},
      </if>
      <if test="subjectId != null" >
        subject_id = #{subjectId,jdbcType=BIGINT},
      </if>
      <if test="sendAddress != null" >
        send_address = #{sendAddress,jdbcType=VARCHAR},
      </if>
      <if test="longtitude != null" >
        longtitude = #{longtitude,jdbcType=REAL},
      </if>
      <if test="latitude != null" >
        latitude = #{latitude,jdbcType=REAL},
      </if>
      <if test="getTime != null" >
        get_time = #{getTime,jdbcType=TIMESTAMP},
      </if>
      <if test="finishTime != null" >
        finish_time = #{finishTime,jdbcType=TIMESTAMP},
      </if>
      <if test="finalTime != null" >
        final_time = #{finalTime,jdbcType=TIMESTAMP},
      </if>
      <if test="sendTime != null" >
        send_time = #{sendTime,jdbcType=TIMESTAMP},
      </if>
      <if test="provCode != null" >
        prov_code = #{provCode,jdbcType=VARCHAR},
      </if>
      <if test="cityCode != null" >
        city_code = #{cityCode,jdbcType=VARCHAR},
      </if>
      <if test="areaCode != null" >
        area_code = #{areaCode,jdbcType=VARCHAR},
      </if>
      <if test="grabAddress != null" >
        grab_address = #{grabAddress,jdbcType=VARCHAR},
      </if>
      <if test="grabLongtitude != null" >
        grab_longtitude = #{grabLongtitude,jdbcType=REAL},
      </if>
      <if test="grabLatitude != null" >
        grab_latitude = #{grabLatitude,jdbcType=REAL},
      </if>
      <if test="groupUserId != null" >
        group_user_id = #{groupUserId,jdbcType=BIGINT},
      </if>
      <if test="groupUserName != null" >
        group_user_name = #{groupUserName,jdbcType=VARCHAR},
      </if>
      <if test="buyerTel != null" >
        buyer_tel = #{buyerTel,jdbcType=VARCHAR},
      </if>
      <if test="sellerTel != null" >
        seller_tel = #{sellerTel,jdbcType=VARCHAR},
      </if>
      <if test="entrustTel != null" >
        entrust_tel = #{entrustTel,jdbcType=VARCHAR},
      </if>
      <if test="sendUserId != null" >
        send_user_id = #{sendUserId,jdbcType=BIGINT},
      </if>
      <if test="sendUserName != null" >
        send_user_name = #{sendUserName,jdbcType=VARCHAR},
      </if>
      <if test="preliminaryTime != null" >
        preliminary_time = #{preliminaryTime,jdbcType=TIMESTAMP},
      </if>
      <if test="isEntrust != null" >
        is_entrust = #{isEntrust},
      </if>
      <if test="isConfirm != null" >
        is_confirm = #{isConfirm,jdbcType=VARCHAR},
      </if>
      <if test="createdBy != null" >
        created_by = #{createdBy,jdbcType=VARCHAR},
      </if>
      <if test="updatedBy != null" >
        updated_by = #{updatedBy,jdbcType=VARCHAR},
      </if>
      <if test="createTime != null" >
        create_time = #{createTime,jdbcType=TIMESTAMP},
      </if>
      <if test="updateTime != null" >
        update_time = #{updateTime,jdbcType=TIMESTAMP},
      </if>
    </set>
    where id = #{id,jdbcType=BIGINT}
  </update>
  <update id="updateByPrimaryKey" parameterType="net.chetong.order.model.HyOrderVO" >
    update hy_order
    set order_no = #{orderNo,jdbcType=VARCHAR},
       task_id = #{taskId,jdbcType=VARCHAR},
       work_id = #{workId,jdbcType=BIGINT},
       mileage = #{mileage,jdbcType=REAL},
      deal_stat = #{dealStat,jdbcType=BIGINT},
      seller_user_id = #{sellerUserId,jdbcType=BIGINT},
      buyer_user_id = #{buyerUserId,jdbcType=BIGINT},
      entrust_user_id = #{entrustUserId,jdbcType=BIGINT},
      payer_user_id = #{payerUserId,jdbcType=BIGINT},
      payer_user_name = #{payerUserName,jdbcType=BIGINT},
      seller_user_name = #{sellerUserName,jdbcType=VARCHAR},
      buyer_user_name = #{buyerUserName,jdbcType=VARCHAR},
      entrust_user_name = #{entrustUserName,jdbcType=VARCHAR},
      case_no = #{caseNo,jdbcType=VARCHAR},
      service_id = #{serviceId,jdbcType=BIGINT},
      subject_id = #{subjectId,jdbcType=BIGINT},
      send_address = #{sendAddress,jdbcType=VARCHAR},
      longtitude = #{longtitude,jdbcType=REAL},
      latitude = #{latitude,jdbcType=REAL},
      get_time = #{getTime,jdbcType=TIMESTAMP},
      finish_time = #{finishTime,jdbcType=TIMESTAMP},
      final_time = #{finalTime,jdbcType=TIMESTAMP},
      send_time = #{sendTime,jdbcType=TIMESTAMP},
      prov_code = #{provCode,jdbcType=VARCHAR},
      city_code = #{cityCode,jdbcType=VARCHAR},
      area_code = #{areaCode,jdbcType=VARCHAR},
      grab_address = #{grabAddress,jdbcType=VARCHAR},
      grab_longtitude = #{grabLongtitude,jdbcType=REAL},
      grab_latitude = #{grabLatitude,jdbcType=REAL},
      group_user_id = #{groupUserId,jdbcType=BIGINT},
      group_user_name = #{groupUserName,jdbcType=VARCHAR},
      buyer_tel = #{buyerTel,jdbcType=VARCHAR},
      seller_tel = #{sellerTel,jdbcType=VARCHAR},
      entrust_tel = #{entrustTel,jdbcType=VARCHAR},
      send_user_id = #{sendUserId,jdbcType=BIGINT},
      send_user_name = #{sendUserName,jdbcType=VARCHAR},
      preliminary_time = #{preliminaryTime,jdbcType=TIMESTAMP},
      is_entrust = #{isEntrust},
      is_confirm = #{isConfirm,jdbcType=VARCHAR},
      created_by = #{createdBy,jdbcType=VARCHAR},
      updated_by = #{updatedBy,jdbcType=VARCHAR},
      create_time = #{createTime,jdbcType=TIMESTAMP},
      update_time = #{updateTime,jdbcType=TIMESTAMP}
    where id = #{id,jdbcType=BIGINT}
  </update>

  <select id="queryHyOrderInfo" parameterType="java.util.Map" resultMap="BaseResultMap">
  	select 
  	<include refid="Base_Column_List" />
    from hy_order
  	<where>
  			<if test="id != null" >
        		and id = #{id}
      		</if>
      		<if test="orderNo != null" >
        		and order_no = #{orderNo}
      		</if>
      		<if test="caseNo != null" >
        		and case_no = #{caseNo}
      		</if>
      		<if test="dealStat != null" >
        		and deal_stat = #{dealStat}
      		</if>
      		<if test="userId != null and userId != ''" >
        		and seller_user_id = #{userId}
      		</if>
      		
  	</where>
  </select>
  
  <select id="queryHyOrderNoAudited" parameterType="java.util.Map" resultType="Long">
  	select 
  		count(1)
    from hy_order
  	where
   		order_no = #{orderNo}
   		and seller_user_id = #{userId}
   		and deal_stat != "09"
  </select>
  
  <select id="queryOrderInfoList" parameterType="map" resultType="map">
  	SELECT 
	 o.id,
	 o.order_no AS orderNo,
	 t.transport_type as transportType,
	 o.buyer_user_id AS buyerUserId,
     o.buyer_user_name AS buyerUserName,
     o.entrust_user_name AS entrustUserName,
     o.deal_stat AS dealStat,
     CASE o.deal_stat
     WHEN '00' THEN '派单中'
     WHEN '01' THEN '无响应'
     WHEN '02' THEN '注销'
     WHEN '03' THEN '撤单'
     WHEN '04' THEN '作业中'
     WHEN '05' THEN '待初审'
     WHEN '06' THEN '初审退回'
     WHEN '07' THEN '待审核'
     WHEN '08' THEN '已退回'
     WHEN '09' THEN '审核通过'
     WHEN '10' THEN '已删除'
     ELSE '未知'
     END AS dealStatDesc,
     DATE_FORMAT( o.send_time,'%Y-%m-%d %H:%i:%s') AS sendTime,
     (SELECT g.conn_tel1 FROM ct_group g WHERE g.user_id=o.buyer_user_id) AS buyerLinktel,
     o.seller_user_id AS sellerUserId,
     o.seller_user_name AS sellerUserName,
     (SELECT u.mobile FROM ct_user u WHERE u.id=o.seller_user_id) AS sellerUserTel,
     t.case_linkman AS caseLinkman,
     t.case_linktel AS caseLinktel,
     t.accident_address as accidentAddress,
     <if test="userType == 0">
	    (select hc.seller_money from hy_cost hc where hc.order_no = o.order_no limit 0,1) as sellerMoney,
	 </if>
	 <if test="userType == 1">
	    (select hc.buyer_money from hy_cost hc where hc.order_no = o.order_no limit 0,1) as buyerMoney,
	 </if>
	 <if test="userType == 2">
	    (select hc.group_money+hc.seller_money from hy_cost hc where hc.order_no = o.order_no limit 0,1) as groupMoney,
	 </if>
     o.case_no AS caseNo,
     o.send_address as sendAddress,
	 (SELECT fwo.withdraw_reason FROM fm_withdraw_order fwo WHERE fwo.order_no = o.order_no ORDER BY fwo.id desc LIMIT 1) AS withdrawReason,
	 (SELECT date_format(fwo.withdraw_time,'%Y-%m-%d') FROM fm_withdraw_order fwo WHERE fwo.order_no = o.order_no ORDER BY fwo.id desc LIMIT 1) AS withdrawTime
	 FROM hy_order o,hy_order_case c,hy_order_task t
	 WHERE o.case_no=c.case_no
	 AND o.order_no = t.order_no
	 <if test="dealStatList!=null and dealStatList.size() > 0">
	 	AND o.deal_stat in 
	 	<foreach collection="dealStatList" item="dealStatItem" open="(" separator="," close=")">
	 		#{dealStatItem}
	 	</foreach>
	 </if>
	 <if test="sendTimeBegin!=null">
	<![CDATA[ AND o.send_time>=CONCAT(#{sendTimeBegin},' 00:00:00') ]]> 
	 </if>
	 <if test="sendTimeEnd!=null">
	 <![CDATA[	AND o.send_time<=CONCAT(#{sendTimeEnd},' 23:59:59') ]]> 
	 </if>
	 <if test="finalTimeBegin!=null and finalTimeBegin!=''">
		<![CDATA[ AND o.final_time>=CONCAT(#{finalTimeBegin},' 00:00:00') ]]> 
	 </if>
	 <if test="finalTimeEnd!=null and finalTimeEnd!=''">
	 	<![CDATA[	AND o.final_time<=CONCAT(#{finalTimeEnd},' 23:59:59') ]]> 
	 </if>
	 <if test="fuzzySearch!=null">
	 	AND CONCAT(ifnull(o.order_no,''),'|',ifnull(o.case_no,''),'|',ifnull(t.case_linkman,''),'|',ifnull(o.buyer_user_name,''),'|'
	 	,ifnull(o.seller_user_name,''),'|',ifnull(t.accident_address,''),'|'
	 	,ifnull(DATE_FORMAT( o.send_time,'%Y-%m-%d %H:%i:%s'),'')) LIKE CONCAT('%',#{fuzzySearch },'%')
	 </if>
	 <if test="userType == 0">
	    AND o.seller_user_id = #{userId}
	 </if>
	 <if test="userType == 1">
	 	<choose>
	 		<when test="showEntrust == 1">
	 			<trim prefix="AND(" suffix=")" prefixOverrides="OR" >
			 	<if test="helpAudit == 1">
			 		OR o.buyer_user_id IN(
						SELECT DISTINCT t.grant_id_c FROM ct_third_apply_info t WHERE t.grant_type = '2' AND t.status = '2' AND t.service_id = '5' 
						AND (t.apply_id_a = #{userPid} OR t.middle_id_b = #{userPid})
						)
			 	</if>
			 	<if test="beSended == 1">
			 		OR (o.buyer_user_id = #{userPid} and o.send_user_id != #{userPid})
			 	</if>
			 	<if test="helpSend == 1">
			 		OR (o.buyer_user_id != #{userPid} and o.created_by in
			 			<foreach collection="userIds" item="uid" open="(" separator="," close=")">
	 						#{uid}
	 					</foreach>
			 		)
			 	</if>
			 	</trim>
	 		</when>
	 		<otherwise>
	 			AND o.buyer_user_id = #{userPid}
	 		</otherwise>
	 	</choose>
	 </if>
	 <if test="userType == 2">
	    AND o.group_user_id = #{userId}
	 </if>
	 order by o.id desc
  </select>
  
  <select id="queryOrderListRelate" parameterType="map" resultType="map">
  	select 
  	   o.id as id,
  	   o.order_no as orderNo,
  	   o.case_no as caseNo,
  	   o.service_id as serviceId,
  	   t.transport_type as transportType,
  	   o.buyer_user_name as buyerUserName,
  	   o.buyer_user_id as buyerUserId,
  	   o.entrust_user_name AS entrustUserName,
  	   (SELECT g.conn_tel1 FROM ct_group g WHERE g.user_id=o.buyer_user_id) AS buyerTel,
  	   o.seller_user_id AS sellerUserId,
       o.seller_user_name AS sellerUserName,
       <if test="userType == 0">
	    IFNULL(c.seller_money,0) AS payMoney, 
	   </if>
	   <if test="userType == 1">
	    IFNULL(c.buyer_money,0) AS payMoney, 
	   </if>
	   <if test="userType == 2">
	    (IFNULL(c.seller_money,0)+IFNULL(c.group_money,0)) AS payMoney, 
	   </if>
       (SELECT u.mobile FROM ct_user u WHERE u.id=o.seller_user_id) AS sellerTel,
  	   o.send_address as sendAddress,
  	   o.deal_stat AS dealStat,
	     CASE o.deal_stat
	     WHEN '00' THEN '派单中'
	     WHEN '01' THEN '无响应'
	     WHEN '02' THEN '注销'
	     WHEN '03' THEN '撤单'
	     WHEN '04' THEN '作业中'
	     WHEN '05' THEN '待初审'
	     WHEN '06' THEN '初审退回'
	     WHEN '07' THEN '待审核'
	     WHEN '08' THEN '已退回'
	     WHEN '09' THEN '审核通过'
	     WHEN '10' THEN '已删除'
	     ELSE '未知'
	     END AS dealStatDesc,
        DATE_FORMAT( o.send_time,'%Y-%m-%d %H:%i:%s') AS sendTime,
       t.accident_address as accidentAddress,
  	   t.case_linkman as caseLinkman,
  	   t.case_linktel as caseLinktel,
  	   t.cargo_name as cargoName,
  	   t.support_linkman as supportLinkman,
	   t.support_linktel as supportLinktel
  	from hy_order_task t,hy_order o
  	left join hy_cost c on o.order_no = c.order_no
  	<where>
  		o.order_no = t.order_no
  		and o.case_no = #{caseNo}
  	</where>
  
  </select>
  
  <!-- 修改货运险订单状态 -->
  <update id="updateOrderStatus">
		UPDATE hy_order 
		  <trim prefix="SET" suffixOverrides=",">  
					<if test="dealStat!= null">
		   			deal_stat = #{dealStat},
		   			</if>  
		  </trim>
		  <where>
		  		<if test="orderNo!= null">
                    and order_no=#{orderNo}
                </if>
                and deal_stat in ('01','03')
		 </where>
	</update>
	
	
	<select id="queryOrderRole" parameterType="java.lang.String" resultType="Map">
  		select o.seller_user_id,o.buyer_user_id,o.group_user_id from hy_order o where o.order_no = #{orderNo}
    </select>
    
    
    <select id="queryAllOrderRelate" parameterType="String" resultType="String">
    	select o.order_no from hy_order o
    	<where>
    	  o.case_no = (select o2.case_no from hy_order o2 where o2.order_no = #{orderNo}) and o.order_no != #{orderNo}
    	</where>
    </select>   
    
  <select id="selectOrderByNo" resultMap="BaseResultMap" parameterType="String" >
    select 
    <include refid="Base_Column_List" />
    from hy_order
    where order_no = #{orderNo}
  </select>
  
  <update id="updateCtArriveInfo" parameterType="map">
  	update hy_order set ct_arrive_info = #{ctArriveInfo} 
  	<where>
  		order_no = #{orderNo}
  	</where>
  </update>
  
  <select id="queryHyOrder" parameterType="net.chetong.order.model.HyOrderVO" resultMap="BaseResultMap">
  	select 
  	<include refid="Base_Column_List" />
    from hy_order
  	<where>
  			<if test="id != null" >
        		and id = #{id}
      		</if>
      		<if test="orderNo != null" >
        		and order_no = #{orderNo}
      		</if>
      		<if test="caseNo != null" >
        		and case_no = #{caseNo}
      		</if>
      		<if test="dealStat != null" >
        		and deal_stat = #{dealStat}
      		</if>
      		<if test="sellerUserId != null" >
        		and seller_user_id = #{sellerUserId}
      		</if>
      		
  	</where>
  </select>
  
  <update id="updateOrderTimeoutById" parameterType="java.util.Map">
	
		update hy_order o
		  set o.deal_stat = '01'
		  where o.id = #{orderId}
		    and o.deal_stat = '00'
		
	</update>
	
	 <!-- 买家注销订单 -->
    <update id="setOderCanceledByOrderNo">
    	UPDATE hy_order
			SET deal_stat = '02'
		WHERE
			order_no = #{orderNo}
		AND deal_stat IN('01','03')
    </update>
    
    <!--根据报案号查询订单  -->
    <select id="queryOrderByCaseNo" parameterType="String" resultMap="BaseResultMap">
    	select 
  			<include refid="Base_Column_List" />
   		 from hy_order
  		<where>
        	case_no = #{caseNo}
  		</where>
    </select>
    
    <select id="queryOrderBySellerAndOrderNo" parameterType="java.util.Map" resultMap="BaseResultMap">
    	SELECT
		  ho.id,
		  ho.order_no,
		  ho.buyer_user_id
		FROM hy_order ho
		WHERE ho.order_no = #{orderNo}
		    AND ho.seller_user_id = #{sellerUserId}
    </select>
</mapper>